{% extends "base.html" %} {% block title %}Edit Profile - SkillSwap{% endblock
%} {% block content %}
<div class="container py-5">
  <h2 class="fw-bold mb-4">Edit Profile</h2>

  <div class="row">
    <div class="col-lg-8">
      <!-- Profile Info -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Personal Information</h5>
        </div>
        <div class="card-body">
          <div id="alert-container"></div>

          <form id="profile-form">
            <div class="mb-3 text-center">
              <img
                src="/static/images/default-avatar.png"
                id="preview-image"
                class="profile-picture mb-3"
                style="
                  width: 100px;
                  height: 100px;
                  object-fit: cover;
                  border-radius: 50%;
                "
              />
              <div class="mt-2">
                <label
                  for="profile_picture"
                  class="btn btn-sm btn-outline-primary"
                >
                  <i class="bi bi-camera"></i> Change Photo
                </label>
                <input
                  type="file"
                  id="profile_picture"
                  class="d-none"
                  accept="image/*"
                  onchange="previewImage(this)"
                />
              </div>
            </div>

            <div class="mb-3">
              <label for="full_name" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="full_name" />
            </div>

            <div class="mb-3">
              <label for="bio" class="form-label">Bio</label>
              <textarea
                class="form-control"
                id="bio"
                rows="3"
                placeholder="Tell others about yourself..."
              ></textarea>
            </div>

            <div class="mb-3">
              <label for="location" class="form-label">Location</label>
              <input
                type="text"
                class="form-control"
                id="location"
                placeholder="e.g., New York, USA"
              />
            </div>

            <div class="mb-3">
              <label for="availability" class="form-label">Availability</label>
              <input
                type="text"
                class="form-control"
                id="availability"
                placeholder="e.g., Weekends, Evenings"
              />
            </div>

            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
      </div>

      <!-- Manage Skills -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Manage Skills</h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <label for="skill-select" class="form-label">Add a Skill</label>
            <div class="row g-2">
              <div class="col-md-6">
                <select class="form-select" id="skill-select">
                  <option value="">Select a skill...</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="proficiency-select">
                  <option value="Beginner">Beginner</option>
                  <option value="Intermediate">Intermediate</option>
                  <option value="Expert">Expert</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="type-select">
                  <option value="teaching">Teaching</option>
                  <option value="learning">Learning</option>
                </select>
              </div>
            </div>
            <button class="btn btn-success mt-2" onclick="addSkill()">
              <i class="bi bi-plus"></i> Add Skill
            </button>
          </div>

          <div class="row">
            <div class="col-md-6">
              <h6 class="fw-bold">Skills I Teach</h6>
              <div id="teaching-skills"></div>
            </div>
            <div class="col-md-6">
              <h6 class="fw-bold">Skills I Want to Learn</h6>
              <div id="learning-skills"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  const API_URL = "https://swkillswap2-1.onrender.com/api";
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user") || "null");

  if (!token || !user) {
    window.location.href = "/login";
  }

  let allSkills = [];
  let userSkills = { teaching: [], learning: [] };

  async function loadProfile() {
    try {
      // Load user profile
      const response = await fetch(`${API_URL}/profile/${user.id}`);
      const data = await response.json();

      if (response.ok) {
        // Populate form
        document.getElementById("full_name").value = data.user.full_name || "";
        document.getElementById("bio").value = data.user.bio || "";
        document.getElementById("location").value = data.user.location || "";
        document.getElementById("availability").value =
          data.user.availability || "";

        if (data.user.profile_picture) {
          document.getElementById("preview-image").src =
            data.user.profile_picture;
        }

        // Store user skills
        userSkills.teaching = data.teaching_skills;
        userSkills.learning = data.learning_skills;

        displayUserSkills();
      }

      // Load all skills
      const skillsResponse = await fetch(`${API_URL}/skills/`);
      const skillsData = await skillsResponse.json();

      if (skillsResponse.ok) {
        allSkills = skillsData.skills;
        populateSkillSelect();
      }
    } catch (error) {
      console.error("Error loading profile:", error);
    }
  }

  function populateSkillSelect() {
    const select = document.getElementById("skill-select");
    allSkills.forEach((skill) => {
      const option = document.createElement("option");
      option.value = skill.id;
      option.textContent = skill.name;
      select.appendChild(option);
    });
  }

  function displayUserSkills() {
    const teachingContainer = document.getElementById("teaching-skills");
    const learningContainer = document.getElementById("learning-skills");

    teachingContainer.innerHTML =
      userSkills.teaching
        .map(
          (skill) => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="skill-badge">${
                  skill.name
                } <span class="badge badge-${skill.proficiency_level.toLowerCase()}">${
            skill.proficiency_level
          }</span></span>
                <button class="btn btn-sm btn-outline-danger" onclick="removeSkill(${
                  skill.id
                })">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `
        )
        .join("") || '<p class="text-muted small">No skills</p>';

    learningContainer.innerHTML =
      userSkills.learning
        .map(
          (skill) => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="skill-badge">${
                  skill.name
                } <span class="badge badge-${skill.proficiency_level.toLowerCase()}">${
            skill.proficiency_level
          }</span></span>
                <button class="btn btn-sm btn-outline-danger" onclick="removeSkill(${
                  skill.id
                })">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `
        )
        .join("") || '<p class="text-muted small">No skills</p>';
  }

  // Preview image
  function previewImage(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById("preview-image").src = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Update profile
  document
    .getElementById("profile-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData();
      formData.append("full_name", document.getElementById("full_name").value);
      formData.append("bio", document.getElementById("bio").value);
      formData.append("location", document.getElementById("location").value);
      formData.append(
        "availability",
        document.getElementById("availability").value
      );

      const fileInput = document.getElementById("profile_picture");
      if (fileInput.files[0]) {
        formData.append("profile_picture", fileInput.files[0]);
      }

      try {
        const response = await fetch(`${API_URL}/profile/update`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          showAlert("Profile updated successfully!", "success");
          // Update local storage
          localStorage.setItem("user", JSON.stringify(result.user));
        } else {
          showAlert(result.error || "Failed to update profile", "danger");
        }
      } catch (error) {
        showAlert("Network error", "danger");
      }
    });

  async function addSkill() {
    const skillId = document.getElementById("skill-select").value;
    const proficiency = document.getElementById("proficiency-select").value;
    const type = document.getElementById("type-select").value;

    if (!skillId) {
      alert("Please select a skill");
      return;
    }

    try {
      const response = await fetch(`${API_URL}/profile/skills`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          skill_id: parseInt(skillId),
          proficiency_level: proficiency,
          is_teaching: type === "teaching",
          is_learning: type === "learning",
        }),
      });

      if (response.ok) {
        // Reload profile
        loadProfile();
      }
    } catch (error) {
      console.error("Error adding skill:", error);
    }
  }

  async function removeSkill(skillId) {
    try {
      const response = await fetch(`${API_URL}/profile/skills/${skillId}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (response.ok) {
        loadProfile();
      }
    } catch (error) {
      console.error("Error removing skill:", error);
    }
  }

  function showAlert(message, type) {
    const alertContainer = document.getElementById("alert-container");
    alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
  }

  loadProfile();
</script>
{% endblock %}
